// Load shared libraries
@Library('radiant-pipeline-library')_

pipeline {
    agent { label 'master' }

    triggers {
        cron((BRANCH_NAME == "3043") ? "H H(4-5) * * 1-5" : "")
    }

    parameters {
        string(name: 'Box', defaultValue: 'default', description: 'Vagrant Box')
    }    

    stages {
        stage("Destroy VM") {
            steps {
                // Existing VM may or may not exist depending on previous runs
                sh "vagrant destroy -f ${params.Box} || true"
            }
        }
        stage("Setup") {
            steps {    
                sh "vagrant up ${params.Box} --provision-with hoot"
            }
        }
        stage ("Install Hoot") {
            steps {
                sh "vagrant ssh ${params.Box} -c 'sudo yum-config-manager --add-repo https://s3.amazonaws.com/hoot-repo/el7/release/hoot.repo'"
                sh "vagrant ssh ${params.Box} -c 'sudo yum makecache -y'"
                sh "vagrant ssh ${params.Box} -c 'sudo yum install -y hootenanny-autostart-0.2.43-1.el7'"
                sh "vagrant ssh ${params.Box} -c 'hoot version'"
            }
        }
        stage("Core Test - Original Install") {
            steps {
                sh "vagrant ssh ${params.Box} -c 'cd /var/lib/hootenanny; HootTest --diff --glacial --parallel'"
            }
        }
        stage("Update Hoot") {
            steps {
                sh "vagrant ssh ${params.Box} -c 'sudo yum -y update hootenanny-autostart'"
                sh "vagrant ssh ${params.Box} -c 'hoot version'"
            }
        }

        stage("Core Test - Hoot Updated") {
            steps {
                sh "vagrant ssh ${params.Box} -c 'cd /var/lib/hootenanny; HootTest --diff --glacial --parallel'"
            }
        }

    }
    post {
        always {
            script {
                sh "vagrant destroy -f ${params.Box}"
                cleanWs()
            }
        }
    }
}
